# Redirect Rule: Simple Example with a Webtask

This sample demonstrates a minimal implementation of the `redirect` protocol. It contains an Auth0 [rule](http://auth0.com/docs/rules) that will redirect the user to a simple consent form. If the user checks the "I agree" checkbox on this form and clicks the **Submit** button, they are then redirected back to Auth0 to complete the authentication flow. On future logins they will no longer be prompted since the consent action is stored in their user profile.

The consent form is hosted using a simple [Webtask](https://webtask.io/) that you can easily modify and provision and use in your version of the rule.

## Rule Setup

To try this rule out with your own Auth0 account using an existing instance of the consent form webtask, follow these steps:

1. Create a new Auth0 rule using the contents of the [`rule.js`](rule.js) script.
1. In your account's [Rules](https://manage.auth0.com/#/rules) screen, add a setting that has the key `CONSENT_FORM_URL` and the following value:  
  ```
  https://sandbox.it.auth0.com/api/run/simple-redirect-protocol/consent?webtask_no_cache=1&auth0_domain=AUTH0_DOMAIN
  ```

  where:
  * `AUTH0_DOMAIN` is your Auth0 account's tenant domain (e.g. `your-account.auth0.com`)

1. If you have any other active rules, make sure they account for the fact that they could be executed during a redirect protocol continuation (i.e. when `context.protocol === 'redirect-callback'`). For more information, see the [Redirect protocol in rules](https://auth0.com/docs/protocols#redirect-protocol-in-rules) docs page.

1. Try the rule by following the steps in the next section.

## Run the Rule

Try the rule with one of the apps in your account. A simple way to do this is to add `http://jwt.io` as an **Allowed Callback URL** to your app and browse to the following link:  
```
https://AUTH0_DOMAIN/authorize?response_type=token&scope=openid%20profile&client_id=CLIENT_ID&redirect_uri=http://jwt.io&connection=CONNECTION
```

where:
* `AUTH0_DOMAIN` is your Auth0 account's tenant domain (e.g. `your-account.auth0.com`)
* `CLIENT_ID` is the **Client ID** of your app
* `CONNECTION` is the name of the Auth0 Connection you'd like to log in with (e.g. `Username-Password-Authentication`)

You will be prompted with an Auth0 Lock page. After you log in to your specified connection, you will be redirected to the consent form. If you agree and submit the form, you will be redirected back to Auth0, the authentication flow will complete successfully, and you will end up on http://jwt.io, which will present you with the resulting `id_token` (JWT). If you attempt the log in again with the same user, you will bypass the consent form since that user's profile was updated with the following `app_metadata`, which is read by the rule:

```json
{
  "has_consented": true
}
```

If you don't agree to the consent form, but still submit, you will still end up at http://jwt.io, but the URL will contain the authorization error generated by the rule:

```
http://jwt.io/#error=unauthorized&error_description=User%20did%20not%20consent!
```

## Consent Form Setup

If you'd like to play around with your own implementation of the consent form webtask, you can host your own version of the [`webtask.js`](webtask.js) script by following these steps:

1. If you haven't done so already, install the Webtask CLI and configure a container for your Auth0 account by following the steps in the [Webtasks](https://manage.auth0.com/#/account/webtasks) tab of your account settings.
1. While you're in the same directory as the `webtask.js` script, run the following command to create your webtask instance:  
  ```bash
  $ wt create -n consent webtask.js -p "WEBTASK_PROFILE"
  ```

  where:
  * `WEBTASK_PROFILE` is the name of the profile you set up in the previous step

  The output of that command will contain a URL that will be the base URL of the `CONSENT_FORM_URL` setting you configured with the redirect rule. The full URL is that URL appended with `&auth0_domain=AUTH0_DOMAIN`, where `AUTH0_DOMAIN` is your Auth0 account's tenant domain (e.g. `your-account.auth0.com`).

  The full URL will be something like:

  ```
  https://sandbox.it.auth0.com/api/run/WEBTASK_CONTAINER/consent?webtask_no_cache=1&auth0_domain=AUTH0_DOMAIN
  ```

1. In your account's [Rules](https://manage.auth0.com/#/rules) screen, delete the existing `CONSENT_FORM_URL` setting since its not pointing to your webtask instance. Recreate that setting using the full URL obtained in the previous step.

1. Try the rule along with your instance of the webtask by the following the steps in the [Run the Rule](#rule-the-rule) section.

1. If you want make changes to the webtask, you can upload a new version simply by running the same `wt create` command you did before.
